# Provision Azure Terraform remote state infrastructure (bootstrap).
# Uses OIDC; no long-lived Azure secrets required.
# Run once per subscription/prefix to create: resource group, storage account (blob versioning), private container.

name: Provision Terraform State Backend
on:
  workflow_dispatch:
    inputs:
      name_prefix:
        description: 'Resource name prefix (e.g. retailflow-dev). Storage account will have hyphens removed.'
        required: true
        default: 'retailflow-dev'
        type: string
      azure_region:
        description: 'Azure region (default for RetailFlow: East US)'
        required: false
        default: 'East US'
        type: string
      container_name:
        description: 'Blob container name for state'
        required: false
        default: 'tfstate'
        type: string

permissions:
  id-token: write   # Required for OIDC to Azure
  contents: read

env:
  TF_VERSION: '1.5.0'
  ARM_USE_OIDC: true

jobs:
  provision-tfstate:
    name: Provision TF state backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform/backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan -no-color -var="name_prefix=${{ github.event.inputs.name_prefix }}" \
            -var="azure_region=${{ github.event.inputs.azure_region }}" \
            -var="container_name=${{ github.event.inputs.container_name }}" \
            -var='tags={Project="RetailFlow",ManagedBy="GitHub-Actions",Purpose="tfstate-backend"}'
        continue-on-error: false

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve -no-color \
            -var="name_prefix=${{ github.event.inputs.name_prefix }}" \
            -var="azure_region=${{ github.event.inputs.azure_region }}" \
            -var="container_name=${{ github.event.inputs.container_name }}" \
            -var='tags={Project="RetailFlow",ManagedBy="GitHub-Actions",Purpose="tfstate-backend"}'

      - name: Output backend config
        run: terraform output -raw backend_config
        continue-on-error: true
